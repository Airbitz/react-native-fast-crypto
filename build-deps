#!/bin/bash
set -u
set -e

echo Build Started
date
# Pick up the current directory:
CURRENT_DIR=$(pwd)
export BUILD_DIR=$CURRENT_DIR/native-libs/deps/build
#if [ -z ${BUILD_DIR+x} ]; then
#  export BUILD_DIR=${BUILD_DIR:-$CURRENT_DIR/native-libs/deps/build};
#fi

# Do the build:
touch native-libs/deps/recipes/nativecrypto/nativecrypto.recipe
(
    cd native-libs/deps
    make nativecrypto.package-ios-universal $@
    make nativecrypto.build-android-arm nativecrypto.build-android-x86 $@
)

# Copy the results locally:
mkdir -m 0775 -p ios/Headers
mkdir -m 0775 -p ios/Libraries
cp -aL $BUILD_DIR/nativecrypto/nativecrypto-ios-universal/include/* ios/Headers
cp -a $BUILD_DIR/nativecrypto/nativecrypto-ios-universal/lib/* ios/Libraries

BASE="./android"
JNI_DIR="$BASE/jni"
JNI_BUILD_DIR="$JNI_DIR/libs"
ANDROID_PATH="$BASE/src/main"

rm -rf $JNI_BUILD_DIR

mkdir -p $JNI_BUILD_DIR/includes
mkdir -p $JNI_BUILD_DIR/armeabi-v7a
mkdir -p $JNI_BUILD_DIR/x86

cp native-libs/src/native-crypto.h $JNI_BUILD_DIR/includes

sed  -e 's/const char *\*/const char *const /' $JNI_BUILD_DIR/includes/native-crypto.h \
    > $JNI_BUILD_DIR/includes/native-crypto-const.h

echo cp $BUILD_DIR/nativecrypto/android-arm/libnativecrypto.so $JNI_BUILD_DIR/armeabi-v7a/
cp $BUILD_DIR/nativecrypto/android-arm/libnativecrypto.so $JNI_BUILD_DIR/armeabi-v7a/
echo cp $BUILD_DIR/nativecrypto/android-x86/libnativecrypto.so $JNI_BUILD_DIR/x86/
cp $BUILD_DIR/nativecrypto/android-x86/libnativecrypto.so $JNI_BUILD_DIR/x86/

echo Build Finished
date
